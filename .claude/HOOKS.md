# Claude Code Hooks

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€dotfilesã§ç®¡ç†ã—ã¦ã„ã‚‹Claude Code hooksã®è©³ç´°ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

## æ¦‚è¦

Claude Codeã®SessionEndã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã€ä¼šè©±å†…å®¹ã‚’Obsidianã®ãƒ‡ã‚¤ãƒªãƒ¼ãƒŽãƒ¼ãƒˆã«è‡ªå‹•è¨˜éŒ²ã™ã‚‹hookã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
.claude/
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ obsidian-session-logger.py  # Obsidiané€£æºhook
â”œâ”€â”€ settings.json                    # Claude Codeè¨­å®šï¼ˆhookç™»éŒ²ï¼‰
â””â”€â”€ HOOKS.md                        # ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

## Obsidian Session Logger

### ç›®çš„

Claude Codeã¨ã®ä¼šè©±çµ‚äº†æ™‚ã«ã€è¦ç´„ãƒ»å­¦ã³ãƒ»å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Obsidianãƒ‡ã‚¤ãƒªãƒ¼ãƒŽãƒ¼ãƒˆã«è‡ªå‹•è¨˜éŒ²ã™ã‚‹ã€‚

### å‡ºåŠ›å…ˆ

- **ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹**: `/Users/yudai/Documents/note`ï¼ˆç’°å¢ƒå¤‰æ•°`OBSIDIAN_VAULT_PATH`ã§å¤‰æ›´å¯èƒ½ï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼**: `Diary/Daily/YYYY/MM/ðŸ“°YYYY-MM-DD(WWW).md`
- **ä¾‹**: `/Users/yudai/Documents/note/Diary/Daily/2026/01/ðŸ“°2026-01-10(Sat).md`

### å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ

```markdown
## ðŸ¤– Claude Code Log
### [HH:MM:SS] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
**è¦ç´„**
- ä¼šè©±ã®ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ1
- ä¼šè©±ã®ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ2
- ä¼šè©±ã®ä¸»è¦ãªãƒã‚¤ãƒ³ãƒˆ3
**å­¦ã³**
- æŠ€è¡“çš„ãªå­¦ã³1
- ä»Šå¾Œæ´»ç”¨ã§ãã‚‹Tips2
**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**
- `/path/to/file1`
- `/path/to/file2`
---
```

### ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä»•æ§˜ï¼ˆé‡è¦ï¼‰

ä»¥ä¸‹ã®ä»•æ§˜ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ã«ã‚ˆã‚Šæ±ºå®šã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚æ”¹ä¿®æ™‚ã‚‚ç¶­æŒã—ã¦ãã ã•ã„ï¼š

1. **è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«**
   - ãƒ¬ãƒ™ãƒ«2: ã€ŒðŸ¤– Claude Code Logã€ï¼ˆå›ºå®šï¼‰
   - ãƒ¬ãƒ™ãƒ«3: `[æ™‚åˆ»] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«`

2. **å«ã‚ãªã„é …ç›®**
   - Session ID
   - çµ‚äº†ç†ç”±ï¼ˆreasonï¼‰
   - ä½¿ç”¨ãƒ„ãƒ¼ãƒ«

3. **å«ã‚ã‚‹é …ç›®**
   - è¦ç´„ï¼ˆå¿…é ˆï¼‰
   - å­¦ã³ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
   - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰

4. **æ”¹è¡Œãƒ«ãƒ¼ãƒ«**
   - åŸºæœ¬çš„ã«æ”¹è¡Œã¯1ã¤ã®ã¿
   - ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã«ç©ºè¡Œã¯å…¥ã‚Œãªã„
   - æœ€å¾Œã®`---`ã®å¾Œã®ã¿2ã¤ã®æ”¹è¡Œ

### å®Ÿè£…ã®è©³ç´°

#### 1. ä¼šè©±å±¥æ­´ã®èª­ã¿è¾¼ã¿

```python
def load_transcript(transcript_path: str) -> List[Dict]
```

- Claude CodeãŒæä¾›ã™ã‚‹`transcript_path`ã‹ã‚‰JSONLå½¢å¼ã®ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
- å„è¡Œã¯ç‹¬ç«‹ã—ãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆtype: user_message, assistant_message, tool_use, tool_resultï¼‰

#### 2. è¦ç´„ã¨å­¦ã³ã®ç”Ÿæˆ

**å„ªå…ˆé †ä½**: Claude API â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

##### Claude APIä½¿ç”¨æ™‚ï¼ˆæŽ¨å¥¨ï¼‰

```python
def summarize_with_claude_api(conversation: str) -> Optional[Dict[str, str]]
```

- ãƒ¢ãƒ‡ãƒ«: `claude-3-5-haiku-20241022`
- max_tokens: 700
- ä¼šè©±ã®æœ€åˆ4000æ–‡å­—ã‚’å…¥åŠ›
- è¿”ã‚Šå€¤: `{"summary": "...", "learning": "..."}`
- è¦ç´„ã¨å­¦ã³ã‚’åŒæ™‚ã«ç”Ÿæˆï¼ˆé«˜å“è³ªï¼‰

**å¿…è¦ãªç’°å¢ƒ**:
```bash
pip install anthropic
export ANTHROPIC_API_KEY="your-api-key"
```

##### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆAPIæœªä½¿ç”¨æ™‚ï¼‰

```python
def summarize_conversation(conversation: str) -> str
def extract_simple_learning(conversation: str) -> Optional[str]
```

- è¦ç´„: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€åˆ3ã¤ã‚’æŠ½å‡º
- å­¦ã³: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹æŠ½å‡ºï¼ˆhook, è¨­å®š, API, CLI, ãƒ„ãƒ¼ãƒ«, ã‚³ãƒžãƒ³ãƒ‰, æ–¹æ³•, å®Ÿè£…, æ©Ÿèƒ½, ãƒ‘ã‚¿ãƒ¼ãƒ³, ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰

#### 3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã®æŠ½å‡º

```python
def extract_session_title(conversation: str) -> str
```

- æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æŠ½å‡º
- 60æ–‡å­—ã‚’è¶…ãˆã‚‹å ´åˆã¯"..."ã§çœç•¥

#### 4. å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®æŠ½å‡º

```python
def extract_tools_and_files(transcript: List[Dict]) -> Dict[str, any]
```

- tool_useã‚¨ãƒ³ãƒˆãƒªã®`input.file_path`ã‹ã‚‰å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
- æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§è¡¨ç¤º

### hookã®ç™»éŒ²

`settings.json`:
```json
{
  "hooks": {
    "SessionEnd": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "/Users/yudai/dotfiles/.claude/hooks/obsidian-session-logger.py"
          }
        ]
      }
    ]
  }
}
```

**æ³¨æ„**: `$CLAUDE_PROJECT_DIR`ç’°å¢ƒå¤‰æ•°ã¯ç’°å¢ƒã«ã‚ˆã£ã¦è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€çµ¶å¯¾ãƒ‘ã‚¹ã‚’ä½¿ç”¨

### ã‚¹ã‚­ãƒƒãƒ—æ¡ä»¶

ä»¥ä¸‹ã®å ´åˆã¯è¨˜éŒ²ã‚’ã‚¹ã‚­ãƒƒãƒ—:
- `reason == "clear"`: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢æ™‚
- `reason == "resume"`: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹æ™‚
- `transcript`ãŒç©º: ä¼šè©±ãŒãªã„å ´åˆ

### ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½

ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: `~/.claude/obsidian-hook-debug.log`

è¨˜éŒ²å†…å®¹:
- hookå®Ÿè¡Œæ™‚åˆ»
- å—ä¿¡ã—ãŸhookãƒ‡ãƒ¼ã‚¿
- ã‚¹ã‚­ãƒƒãƒ—ç†ç”±
- transcriptãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
- æ›¸ãè¾¼ã¿æˆåŠŸ/å¤±æ•—

ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ™‚ã¯å¿…ãšã“ã®ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã€‚

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ

```bash
ln -sf ~/dotfiles/.claude/hooks ~/.claude/hooks
ln -sf ~/dotfiles/.claude/settings.json ~/.claude/settings.json
```

### 2. Obsidianãƒ‘ã‚¹ã®è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»¥å¤–ã®å ´åˆï¼‰

```bash
# ~/.zshrc ã«è¿½åŠ 
export OBSIDIAN_VAULT_PATH="/path/to/your/obsidian/vault"
```

### 3. Claude APIè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€é«˜å“è³ªãªè¦ç´„ã®ãŸã‚ï¼‰

```bash
pip install anthropic
export ANTHROPIC_API_KEY="your-api-key"
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### hookãŒå‹•ä½œã—ãªã„

1. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ç¢ºèª
```bash
cat ~/.claude/obsidian-hook-debug.log
```

2. hookãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - ãƒ­ã‚°ã«ã€ŒHook triggered atã€ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹
   - è¨˜éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã€settings.jsonãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

3. ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ç¢ºèª
```bash
ls -la ~/.claude/hooks
ls -la ~/.claude/settings.json
```

### è¨˜éŒ²ã•ã‚Œã‚‹ãŒå†…å®¹ãŒç©º

- transcriptãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã«ã€ŒNo transcript foundã€ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### Claude APIè¦ç´„ãŒå‹•ä½œã—ãªã„

1. anthropicãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹
```bash
pip list | grep anthropic
```

2. APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
```bash
echo $ANTHROPIC_API_KEY
```

3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯å‹•ä½œã—ã¦ã„ã‚‹ã¯ãšï¼ˆè¦ç´„ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ï¼‰

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### å®Ÿè£…æ¸ˆã¿

- âœ… Claude APIã«ã‚ˆã‚‹é«˜å“è³ªãªè¦ç´„ç”Ÿæˆ
- âœ… å­¦ã³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è‡ªå‹•ç”Ÿæˆ
- âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ï¼ˆAPIæœªä½¿ç”¨æ™‚ï¼‰
- âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½

### æ¤œè¨Žäº‹é …

1. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®åˆ†é¡ž**
   - `cwd`ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŠ½å‡º
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«è¨˜éŒ²

2. **ã‚¿ã‚°ä»˜ã‘**
   - ä¼šè©±å†…å®¹ã‹ã‚‰è‡ªå‹•çš„ã«ã‚¿ã‚°ã‚’æŠ½å‡º
   - Obsidianã®ã‚¿ã‚°æ©Ÿèƒ½ã¨é€£æº

3. **ä¼šè©±å±¥æ­´å…¨æ–‡ä¿å­˜**
   - è¦ç´„ã¨ã¯åˆ¥ã«ã€å…¨æ–‡ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜
   - å¾Œã‹ã‚‰æ¤œç´¢å¯èƒ½ã«ã™ã‚‹

4. **çµ±è¨ˆæƒ…å ±**
   - æœˆé–“/é€±é–“ã®ä¼šè©±æ•°
   - ã‚ˆãä½¿ã†ãƒ„ãƒ¼ãƒ«
   - å­¦ã³ã®ã‚µãƒžãƒªãƒ¼

## æ”¹ä¿®æ™‚ã®æ³¨æ„ç‚¹

### å¿…ãšå®ˆã‚‹ã“ã¨

1. **ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆä»•æ§˜ã‚’å¤‰æ›´ã—ãªã„**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ã§æ±ºå®šã•ã‚ŒãŸä»•æ§˜
   - è¦‹å‡ºã—ãƒ¬ãƒ™ãƒ«ã€å«ã‚ã‚‹é …ç›®ã€æ”¹è¡Œãƒ«ãƒ¼ãƒ«ã‚’ç¶­æŒ

2. **ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æ®‹ã™**
   - æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã‚‚å¿…ãšãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã«è¨˜éŒ²
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«å¿…é ˆ

3. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’ç¶­æŒ**
   - Claude APIãŒä½¿ãˆãªã„ç’°å¢ƒã§ã‚‚åŸºæœ¬æ©Ÿèƒ½ã¯å‹•ä½œã™ã‚‹ã“ã¨
   - ImportErrorã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ã§ã‚‚Claude Codeã®å‹•ä½œã‚’å¦¨ã’ãªã„
   - sys.exit(0)ã§æ­£å¸¸çµ‚äº†æ‰±ã„ã«ã™ã‚‹

### ãƒ†ã‚¹ãƒˆæ–¹æ³•

æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:

```bash
# ãƒ†ã‚¹ãƒˆç”¨å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ä½œæˆ
cat > /tmp/test_hook_input.json << 'EOF'
{
  "session_id": "test-session-12345",
  "cwd": "/Users/yudai/dotfiles",
  "reason": "exit",
  "transcript_path": "/tmp/test_transcript.jsonl"
}
EOF

# ãƒ†ã‚¹ãƒˆç”¨transcriptä½œæˆ
cat > /tmp/test_transcript.jsonl << 'EOF'
{"type":"user_message","content":"ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"}
{"type":"assistant_message","content":"ãƒ†ã‚¹ãƒˆå¿œç­”"}
{"type":"tool_use","name":"Write","input":{"file_path":"/tmp/test.txt"}}
EOF

# hookã‚’å®Ÿè¡Œ
cat /tmp/test_hook_input.json | ~/dotfiles/.claude/hooks/obsidian-session-logger.py

# ãƒ‡ã‚¤ãƒªãƒ¼ãƒŽãƒ¼ãƒˆã‚’ç¢ºèª
tail -30 ~/Documents/note/Diary/Daily/2026/01/ðŸ“°$(date +%Y-%m-%d)\($(date +%a)\).md
```

## å‚è€ƒæƒ…å ±

- [Claude Code Hooks Documentation](https://docs.anthropic.com/claude-code/hooks)
- Obsidian Vault Path: `/Users/yudai/Documents/note`
- Daily Note Format: `ðŸ“°YYYY-MM-DD(WWW).md`
